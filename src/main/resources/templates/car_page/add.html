<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>차량 관리 추가 페이지</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<h1>차량 관리</h1>
<h2>차량 관리 > 신규 차량 등록</h2>

<form id="add_carData" th:action="@{/api/admin/vehicles/add}" method="post">
    <table>
        <tr>
            <th><label for="carBrand">제조사</label></th>
            <th><label for="carModelName">모델명</label></th>
            <th><label for="carYear">연식</label></th>
            <th><label for="carFuel">연료</label></th>
            <th><label for="carGrade">등급</label></th>
            <th><label for="carCategory">서비스 카테고리</label></th>
        </tr>
        <tr>
            <td>
                <select id="carBrand" name="model.modelBrand">
                    <option th:each="brand: ${mBrandList}" th:value="${brand}" th:text="${brand}"></option>
                </select>
            </td>
            <td>
                <select id="carModelName" name="model.modelName">
                    <option th:each="mName: ${mNameList}" th:value="${mName}" th:text="${mName}"></option>
                </select>
            </td>
            <td>
                <select id="carYear" name="carYear">
                    <option th:each="yearList: ${yearList}" th:value="${yearList}" th:text="${yearList}"></option>
                </select>
            </td>
            <td>
                <select id="carFuel" name="carFuel">
                    <option th:each="fuel : ${fuelList}" th:value="${fuel}" th:text="${fuel}"></option>
                </select>
            </td>
            <td>
                <select id="carGrade" name="carGrade">
                    <option th:each="grade : ${gradeList}" th:value="${grade}" th:text="${grade}"></option>
                </select>
            </td>
            <td>
                <select id="carCategory" name="carCategory" required>
                    <option value="0">빠른대여</option>
                    <option value="1">단기대여</option>
                </select>
            </td>
        </tr>

        <tr>
            <th><label for="parkingProvince">도/시</label></th>
            <th><label for="parkingDistrict">행정구역</label></th>
            <th><label for="carParking">주차장 이름</label></th>
            <th><label for="parkingLatitude">위도</label></th>
            <th><label for="parkingLongitude">경도</label></th>
        </tr>
        <tr>
            <td>
                <select id="parkingProvince" name="parking.province">
                    <option value="">도/시 선택</option>
                    <option th:each="province : ${provinceList}" th:value="${province}" th:text="${province}"></option>
                </select>
            </td>
            <td>
                <select id="parkingDistrict" name="parking.district">
                    <option value="">행정구역 선택</option>
                </select>
            </td>
            <td>
                <select id="carParking" name="parking.parkingId">
                    <option value="">주차장 선택</option>
                </select>
            </td>
            <td>
                <input type="text" id="parkingLatitude" name="parkingLatitude" readonly />
            </td>
            <td>
                <input type="text" id="parkingLongitude" name="parkingLongitude" readonly />
            </td>
        </tr>
        <tr>
            <td colspan="5" style="text-align: center;">
                <button type="button" onclick="location.href='/api/admin/vehicles'">목록</button>
            </td>
            <td>
                <button type="submit">등록하기</button>
            </td>
        </tr>
    </table>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // 1. 도/시 선택 시 행정구역 목록 갱신
        $("#parkingProvince").change(function () {
            let selectedProvince = $(this).val();
            $("#parkingDistrict").empty().append('<option value="">행정구역 선택</option>');
            $("#carParking").empty().append('<option value="">주차장 선택</option>');
            $("#parkingLatitude").val('');
            $("#parkingLongitude").val('');

            if (selectedProvince) {
                $.get("/api/admin/vehicles/districts", { province: selectedProvince }, function (data) {
                    $.each(data, function (index, district) {
                        $("#parkingDistrict").append('<option value="' + district + '">' + district + '</option>');
                    });
                });
            }
        });

        // 2. 행정구역 선택 시 주차장 목록 갱신
        $("#parkingDistrict").change(function () {
            let selectedProvince = $("#parkingProvince").val();
            let selectedDistrict = $(this).val();
            $("#carParking").empty().append('<option value="">주차장 선택</option>');
            $("#parkingLatitude").val('');
            $("#parkingLongitude").val('');

            if (selectedDistrict) {
                $.get("/api/admin/vehicles/parkings", { province: selectedProvince, district: selectedDistrict }, function (data) {
                    $.each(data, function (index, parking) {
                        $("#carParking").append('<option value="' + parking.parkingId + '" data-lat="' + parking.parkingLatitude + '" data-lng="' + parking.parkingLongtitude + '">' + parking.parkingName + '</option>');
                    });
                });
            }
        });

        // 3. 주차장 선택 시 위도, 경도 자동 입력
        $("#carParking").change(function () {
            let selectedOption = $(this).find("option:selected");
            let lat = selectedOption.attr("data-lat");
            let lng = selectedOption.attr("data-lng");

            $("#parkingLatitude").val(lat ? lat : '');
            $("#parkingLongitude").val(lng ? lng : '');
        });
    });
</script>

</body>
</html>