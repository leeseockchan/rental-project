<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¨ëŸ‰ ê´€ë¦¬ ìˆ˜ì •í˜ì´ì§€</title>
</head>
<body th:data-car-id="${modify.carId}">
<h1>ì°¨ëŸ‰ ê´€ë¦¬</h1>
<h2>ì°¨ëŸ‰ ê´€ë¦¬>ì°¨ëŸ‰ ìƒì„¸ì¡°íšŒ>ì°¨ëŸ‰ ê´€ë¦¬ ìˆ˜ì •</h2>
<form id="model_modify" method="POST" th:action="@{/api/admin/vehicles/modify/{carId}(carId=${modify.carId})}">
    <input type="hidden" name="_method" value="PUT">
    <input type="hidden" id="carId" th:value="${modify.carId}">
    <table>
        <tr th:text="|${modify.carId}ë²ˆ ì°¨ëŸ‰ ìˆ˜ì •|"></tr>
        <tr>
            <th><label for="modelBrand">ì œì¡°ì‚¬</label></th>
            <th><label for="modelName">ëª¨ë¸ëª…</label></th>
            <th><label for="carYear">ì—°ì‹</label></th>
            <th><label for="carFuel">ì—°ë£Œ</label></th>
            <th><label for="carGrade">ë“±ê¸‰</label></th>
            <th><label for="carCategory">ì„œë¹„ìŠ¤ ì¹´í…Œê³ ë¦¬</label></th>
        </tr>
        <tr>
            <td>
                <select id="modelBrand" name="model.modelBrand">
                    <option th:each="brand: ${mBrandList}" th:value="${brand}" th:text="${brand}"
                            th:selected="${modify.model.modelBrand == brand}">
                    </option>
                </select>
            </td>
            <td>
                <select id="modelName" name="model.modelName">
                    <option th:each="mName: ${mNameList}" th:value="${mName}" th:text="${mName}"
                            th:selected="${modify.model.modelName == mName}">
                    </option>
                </select>
            </td>
            <td>
                <select id="carYear" name="carYear">
                    <option th:each="year: ${yearList}" th:value="${year}" th:text="${year}"
                            th:selected="${modify.carYear == year}">
                    </option>
                </select>
            </td>
            <td>
                <select id="carFuel" name="carFuel">
                    <option th:each="fuel : ${fuelList}" th:value="${fuel}" th:text="${fuel}"></option>
                </select>
            </td>
            <td>
                <select id="carGrade" name="carGrade">
                    <option th:each="grade : ${gradeList}" th:value="${grade}" th:text="${grade}"></option>
                </select>
            </td>
            <td>
                <select id="carCategory" name="carCategory" required>
                    <option value="0">ë¹ ë¥¸ëŒ€ì—¬</option>
                    <option value="1">ë‹¨ê¸°ëŒ€ì—¬</option>
                </select>
            </td>
        </tr>

        <tr>
            <th><label for="parkingProvince">ë„/ì‹œ</label></th>
            <th><label for="parkingDistrict">í–‰ì •êµ¬ì—­</label></th>
            <th><label for="carParking">ì£¼ì°¨ì¥ ì´ë¦„</label></th>
            <th><label for="parkingLatitude">ìœ„ë„</label></th>
            <th><label for="parkingLongitude">ê²½ë„</label></th>
        </tr>
        <tr>
            <td>
                <select id="parkingProvince" name="parking.province">
                    <option value="">ë„/ì‹œ ì„ íƒ</option>
                    <option th:each="province : ${provinceList}"
                            th:value="${province}"
                            th:text="${province}"
                            th:selected="${province == modify.parking.parkingProvince}">
                    </option>
                </select>
            </td>
            <td>
                <select id="parkingDistrict" name="parking.district">
                    <option value="">í–‰ì •êµ¬ì—­ ì„ íƒ</option>
                    <option th:each="district : ${districtList}"
                            th:value="${district}"
                            th:text="${district}"
                            th:selected="${district == modify.parking.parkingDistrict}">
                    </option>
                </select>
            </td>
            <td>
                <select id="carParking" name="parking.parkingId">
                    <option value="">ì£¼ì°¨ì¥ ì„ íƒ</option>
                    <option th:each="parking : ${parkingList}"
                            th:value="${parking.parkingId}"
                            th:text="${parking.parkingName}"
                            th:selected="${parking.parkingId == modify.parking.parkingId}">
                    </option>
                </select>
            </td>
            <td>
                <input type="text" id="parkingLatitude" name="parkingLatitude" readonly />
            </td>
            <td>
                <input type="text" id="parkingLongitude" name="parkingLongitude" readonly />
            </td>
        </tr>
        <tr>
            <td colspan="3">
                <button type="submit">ìˆ˜ì • ì™„ë£Œ</button>
            </td>
        </tr>
        <tr>
            <td colspan="3">
                <a th:href="@{/api/admin/vehicles/{carId}(carId=${modify.carId})}">
                    <button type="button">ì·¨ì†Œ</button>
                </a>
            </td>
        </tr>
    </table>
</form>
<!--<script src="/js/car/carModify.js"></script>-->
<script>
    document.getElementById("model_modify").addEventListener("submit", function (event) {
        event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€

        const carId = document.getElementById("carId")?.value;
        const modelName = document.getElementById("modelName")?.value;
        const carCategory = document.getElementById("carCategory")?.value;
        const carStatus = document.getElementById("carStatus")?.value;
        const carYear = document.getElementById("carYear")?.value;
        const carFuel = document.getElementById("carFuel")?.value;
        const carGrade = document.getElementById("carGrade")?.value;
        const carOptions = document.getElementById("carOptions")?.value;
        const parkingId = document.getElementById("carParking")?.value;

        console.log("ğŸ”¹ ì „ì†¡ ë°ì´í„°:");
        console.log("carId:", carId);
        console.log("modelName:", modelName);
        console.log("carCategory:", carCategory);
        console.log("carStatus:", carStatus);
        console.log("carYear:", carYear);
        console.log("carFuel:", carFuel);
        console.log("carGrade:", carGrade);
        console.log("carOptions:", carOptions);
        console.log("parkingId:", parkingId);

        fetch(`/api/admin/vehicles/modify/${carId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: { modelName: modelName },
                carCategory: carCategory,
                carStatus: carStatus,
                carYear: carYear,
                carFuel: carFuel,
                carGrade: carGrade,
                carOptions: carOptions,
                parking: { parkingId: parkingId }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("ìˆ˜ì • ì™„ë£Œ");
                window.location.href = `/api/admin/vehicles/${carId}`;
            } else {
                alert("ìˆ˜ì • ì‹¤íŒ¨: " + data.message);
            }
        })
        .catch(error => console.error("Error:", error));
    });



            document.addEventListener("DOMContentLoaded", function () {
                const provinceSelect = document.getElementById("parkingProvince");
                const districtSelect = document.getElementById("parkingDistrict");
                const parkingSelect = document.getElementById("carParking");
                const latitudeInput = document.getElementById("parkingLatitude");
                const longitudeInput = document.getElementById("parkingLongitude");

                // 1. ë„/ì‹œ ì„ íƒ ì‹œ í•´ë‹¹ ì‹œ/ë„ì˜ í–‰ì •êµ¬ì—­ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                provinceSelect.addEventListener("change", function () {
                    const province = this.value;
                    districtSelect.innerHTML = '<option value="">í–‰ì •êµ¬ì—­ ì„ íƒ</option>';
                    parkingSelect.innerHTML = '<option value="">ì£¼ì°¨ì¥ ì„ íƒ</option>';
                    latitudeInput.value = "";
                    longitudeInput.value = "";

                    if (province) {
                        fetch(`/api/admin/vehicles/districts?province=${encodeURIComponent(province)}`)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(district => {
                                    let option = new Option(district, district);
                                    districtSelect.add(option);
                                });
                            })
                            .catch(error => console.error("Error fetching districts:", error));
                    }
                });

                // 2. í–‰ì •êµ¬ì—­ ì„ íƒ ì‹œ í•´ë‹¹ ì§€ì—­ì˜ ì£¼ì°¨ì¥ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                districtSelect.addEventListener("change", function () {
                    const province = provinceSelect.value;
                    const district = this.value;
                    parkingSelect.innerHTML = '<option value="">ì£¼ì°¨ì¥ ì„ íƒ</option>';
                    latitudeInput.value = "";
                    longitudeInput.value = "";

                    if (province && district) {
                        fetch(`/api/admin/vehicles/parkings?province=${encodeURIComponent(province)}&district=${encodeURIComponent(district)}`)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(parking => {
                                    let option = new Option(parking.parkingName, parking.parkingId);
                                    parkingSelect.add(option);
                                    option.dataset.latitude = parking.latitude;
                                    option.dataset.longitude = parking.longitude;
                                });
                            })
                            .catch(error => console.error("Error fetching parkings:", error));
                    }
                });

                // 3. ì£¼ì°¨ì¥ ì„ íƒ ì‹œ ìœ„ë„, ê²½ë„ ìë™ ì…ë ¥
                parkingSelect.addEventListener("change", function () {
                    const selectedOption = this.options[this.selectedIndex];
                    latitudeInput.value = selectedOption.dataset.latitude || "";
                    longitudeInput.value = selectedOption.dataset.longitude || "";
                });
            });
</script>
</body>
</html>