<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>차량 관리 수정페이지</title>
</head>
<body th:data-car-id="${modify.carId}">
<h1>차량 관리</h1>
<h2>차량 관리>차량 상세조회>차량 관리 수정</h2>
<form id="model_modify" method="POST" th:action="@{/api/admin/vehicles/modify/{carId}(carId=${modify.carId})}">
    <input type="hidden" name="_method" value="PUT">
    <input type="hidden" id="carId" th:value="${modify.carId}">
    <table>
        <tr th:text="|${modify.carId}번 차량 수정|"></tr>
        <tr>
            <th><label for="modelBrand">제조사</label></th>
            <th><label for="modelName">모델명</label></th>
            <th><label for="carYear">연식</label></th>
            <th><label for="carFuel">연료</label></th>
            <th><label for="carGrade">등급</label></th>
            <th><label for="carCategory">서비스 카테고리</label></th>
        </tr>
        <tr>
            <td>
                <select id="modelBrand" name="model.modelBrand">
                    <option th:each="brand: ${mBrandList}" th:value="${brand}" th:text="${brand}"
                            th:selected="${modify.model.modelBrand == brand}">
                    </option>
                </select>
            </td>
            <td>
                <select id="modelName" name="model.modelName">
                    <option th:each="mName: ${mNameList}" th:value="${mName}" th:text="${mName}"
                            th:selected="${modify.model.modelName == mName}">
                    </option>
                </select>
            </td>
            <td>
                <select id="carYear" name="carYear">
                    <option th:each="year: ${yearList}" th:value="${year}" th:text="${year}"
                            th:selected="${modify.carYear == year}">
                    </option>
                </select>
            </td>
            <td>
                <select id="carFuel" name="carFuel">
                    <option th:each="fuel : ${fuelList}" th:value="${fuel}" th:text="${fuel}"></option>
                </select>
            </td>
            <td>
                <select id="carGrade" name="carGrade">
                    <option th:each="grade : ${gradeList}" th:value="${grade}" th:text="${grade}"></option>
                </select>
            </td>
            <td>
                <select id="carCategory" name="carCategory" required>
                    <option value="0">빠른대여</option>
                    <option value="1">단기대여</option>
                </select>
            </td>
        </tr>

        <tr>
            <th><label for="parkingProvince">도/시</label></th>
            <th><label for="parkingDistrict">행정구역</label></th>
            <th><label for="carParking">주차장 이름</label></th>
            <th><label for="parkingLatitude">위도</label></th>
            <th><label for="parkingLongitude">경도</label></th>
        </tr>
        <tr>
            <td>
                <select id="parkingProvince" name="parking.province">
                    <option value="">도/시 선택</option>
                    <option th:each="province : ${provinceList}"
                            th:value="${province}"
                            th:text="${province}"
                            th:selected="${province == modify.parking.parkingProvince}">
                    </option>
                </select>
            </td>
            <td>
                <select id="parkingDistrict" name="parking.district">
                    <option value="">행정구역 선택</option>
                    <option th:each="district : ${districtList}"
                            th:value="${district}"
                            th:text="${district}"
                            th:selected="${district == modify.parking.parkingDistrict}">
                    </option>
                </select>
            </td>
            <td>
                <select id="carParking" name="parking.parkingId">
                    <option value="">주차장 선택</option>
                    <option th:each="parking : ${parkingList}"
                            th:value="${parking.parkingId}"
                            th:text="${parking.parkingName}"
                            th:selected="${parking.parkingId == modify.parking.parkingId}">
                    </option>
                </select>
            </td>
            <td>
                <input type="text" id="parkingLatitude" name="parkingLatitude" readonly />
            </td>
            <td>
                <input type="text" id="parkingLongitude" name="parkingLongitude" readonly />
            </td>
        </tr>
        <tr>
            <td colspan="3">
                <button type="submit">수정 완료</button>
            </td>
        </tr>
        <tr>
            <td colspan="3">
                <a th:href="@{/api/admin/vehicles/{carId}(carId=${modify.carId})}">
                    <button type="button">취소</button>
                </a>
            </td>
        </tr>
    </table>
</form>
<!--<script src="/js/car/carModify.js"></script>-->
<script>
    document.getElementById("model_modify").addEventListener("submit", function (event) {
        event.preventDefault(); // 기본 폼 제출 방지

        const carId = document.getElementById("carId")?.value;
        const modelName = document.getElementById("modelName")?.value;
        const carCategory = document.getElementById("carCategory")?.value;
        const carStatus = document.getElementById("carStatus")?.value;
        const carYear = document.getElementById("carYear")?.value;
        const carFuel = document.getElementById("carFuel")?.value;
        const carGrade = document.getElementById("carGrade")?.value;
        const carOptions = document.getElementById("carOptions")?.value;
        const parkingId = document.getElementById("carParking")?.value;

        console.log("🔹 전송 데이터:");
        console.log("carId:", carId);
        console.log("modelName:", modelName);
        console.log("carCategory:", carCategory);
        console.log("carStatus:", carStatus);
        console.log("carYear:", carYear);
        console.log("carFuel:", carFuel);
        console.log("carGrade:", carGrade);
        console.log("carOptions:", carOptions);
        console.log("parkingId:", parkingId);

        fetch(`/api/admin/vehicles/modify/${carId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                model: { modelName: modelName },
                carCategory: carCategory,
                carStatus: carStatus,
                carYear: carYear,
                carFuel: carFuel,
                carGrade: carGrade,
                carOptions: carOptions,
                parking: { parkingId: parkingId }
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("수정 완료");
                window.location.href = `/api/admin/vehicles/${carId}`;
            } else {
                alert("수정 실패: " + data.message);
            }
        })
        .catch(error => console.error("Error:", error));
    });



            document.addEventListener("DOMContentLoaded", function () {
                const provinceSelect = document.getElementById("parkingProvince");
                const districtSelect = document.getElementById("parkingDistrict");
                const parkingSelect = document.getElementById("carParking");
                const latitudeInput = document.getElementById("parkingLatitude");
                const longitudeInput = document.getElementById("parkingLongitude");

                // 1. 도/시 선택 시 해당 시/도의 행정구역 목록 가져오기
                provinceSelect.addEventListener("change", function () {
                    const province = this.value;
                    districtSelect.innerHTML = '<option value="">행정구역 선택</option>';
                    parkingSelect.innerHTML = '<option value="">주차장 선택</option>';
                    latitudeInput.value = "";
                    longitudeInput.value = "";

                    if (province) {
                        fetch(`/api/admin/vehicles/districts?province=${encodeURIComponent(province)}`)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(district => {
                                    let option = new Option(district, district);
                                    districtSelect.add(option);
                                });
                            })
                            .catch(error => console.error("Error fetching districts:", error));
                    }
                });

                // 2. 행정구역 선택 시 해당 지역의 주차장 목록 가져오기
                districtSelect.addEventListener("change", function () {
                    const province = provinceSelect.value;
                    const district = this.value;
                    parkingSelect.innerHTML = '<option value="">주차장 선택</option>';
                    latitudeInput.value = "";
                    longitudeInput.value = "";

                    if (province && district) {
                        fetch(`/api/admin/vehicles/parkings?province=${encodeURIComponent(province)}&district=${encodeURIComponent(district)}`)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(parking => {
                                    let option = new Option(parking.parkingName, parking.parkingId);
                                    parkingSelect.add(option);
                                    option.dataset.latitude = parking.latitude;
                                    option.dataset.longitude = parking.longitude;
                                });
                            })
                            .catch(error => console.error("Error fetching parkings:", error));
                    }
                });

                // 3. 주차장 선택 시 위도, 경도 자동 입력
                parkingSelect.addEventListener("change", function () {
                    const selectedOption = this.options[this.selectedIndex];
                    latitudeInput.value = selectedOption.dataset.latitude || "";
                    longitudeInput.value = selectedOption.dataset.longitude || "";
                });
            });
</script>
</body>
</html>