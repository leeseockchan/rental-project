<!DOCTYPE html>
<html lang="utf-8" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf"
    layout:decorate="~{layout/layout}">

<head>
    <title>차량 관리 목록</title>

    <link rel="stylesheet" th:href="@{/css/car/car-list.css}">

    <!--    아파치 E차트-->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.6.0/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script th:src="@{/js/car/chart.js}" defer></script>

    <script th:inline="javascript">
        var carGradeData = /*[[${carGrades}]]*/ '[]';
        var carRankingData = /*[[${carRanking}]]*/ '[]';
        var carBrandData = /*[[${carBrands}]]*/ '[]';

        // JSON 변환
        var carGradeParsed = [[${carGrades}]];
        var carRankingParsed = [[${carRanking}]];
        var carBrandParsed = [[${carBrands}]];
    </script>

    <script th:inline="javascript">
        $(document).ready(function () {
            // ✅ 시/도 목록 불러오기 (17개가 정상적으로 나오는지 확인)
            $.get("/admin/vehicles/provinces", function (data) {
                $("#provinceSelect").empty().append('<option value="">시/도를 선택하세요</option>');
                $.each(data, function (index, province) {
                    $("#provinceSelect").append('<option value="' + province + '">' + province + '</option>');
                });
            });
            // ✅ 시/도 선택 시, 해당 시/군/구 가져오기
            $("#provinceSelect").change(function () {
                let province = $(this).val().trim();
                $("#districtSelect").empty().append('<option value="">시/군/구를 선택하세요</option>');

                if (province) {
                    $.get("/admin/vehicles/districts", { province: province }, function (data) {
                        console.log("📌 시/군/구 목록:", data); // 👉 응답 데이터 확인
                        $.each(data, function (index, district) {
                            $("#districtSelect").append('<option value="' + district + '">' + district + '</option>');
                        });
                    });
                }
            });

            // ✅ 차량 검색 버튼 클릭 시
            $("#searchBtn").click(function () {
                let province = $("#provinceSelect").val();
                let district = $("#districtSelect").val();

                if (!province) {
                    alert("시/도를 선택해주세요.");
                    return;
                }
                if (!district) {
                    alert("시/군/구를 선택해주세요.");
                    return;
                }

                $.get("/admin/vehicles/search", { province: province, district: district }, function (cars) {
                    if (cars.length === 0) {
                        alert("검색 결과가 없습니다.");
                        $("#carList").html("");  // 테이블 초기화
                        return;
                    }

                    let carListHtml = "";
                    $.each(cars, function (index, car) {
                        carListHtml += `
                        <tr onclick="location.href='/admin/vehicles/${car.carId}'" style="cursor: pointer;">
                            <td>${car.carId}</td>
                            <td>${car.model.modelBrand}</td>
                            <td>${car.model.modelName}</td>
                            <td>${car.carGrade}</td>
                            <td>${car.carCategory}</td>
                            <td>${car.carStatus}</td>
                            <td>${car.parking.parkingName}</td>
                        </tr>`;
                    });
                    $("#carList").html(carListHtml);
                }).fail(function () {
                    alert("검색 중 오류가 발생했습니다.");
                });
            });
        });
    </script>

</head>

<body>
    <div class="content" layout:fragment="content">

        <div class="header">
            차량 관리
        </div>

        <div class="info">
            <div class="info-header">보유 차량 통계</div>

            <div class="info-box-big-group">
                <div class="info-box-big only-text-box-big">
                    <div class="info-box-big-header">전체 차량 대수</div>
                    <div class="info-box-sm">
                        <div class="info-box box1">
                            <div class="info-box-title">전체 보유 차량</div>
                            <div class="info-box-content"><span th:text="${totalVehicles}"></span> 대</div>
                        </div>
                        <div class="info-box box2">
                            <div class="info-box-title">현재 대여중인 차량</div>
                            <div class="info-box-content"><span th:text="${rentedVehicles}"></span> 대</div>
                        </div>
                        <div class="info-box box3">
                            <div class="info-box-title">수리중인 차량</div>
                            <div class="info-box-content"><span th:text="${repairVehicles}"></span> 대</div>
                        </div>
                    </div>
                </div>
                <div class="info-box-big semi-circle-box-big">
                    <div class="info-box-big-header" style="margin-bottom : 0">차량 등급별 보유 현황</div>
                    <div class="chart-box semi-circle-box">
                        <div class="chart-content chart1" id="chart-container1"></div>
                    </div>
                </div>
            </div>

            <div class="info-box-big-group">
                <div class="info-box-big">
                    <div class="info-box-big-header">보유 차량 순위</div>
                    <div class="chart-box">
                        <div class="chart-content chart2" id="chart-container2">
                        </div>
                    </div>
                </div>
                <div class="info-box-big">
                    <div class="info-box-big-header">제조사 별 차량 대수</div>
                    <div class="chart-box">
                        <div class="chart-content chart3" id="chart-container3"></div>
                    </div>
                </div>
            </div>

        </div>

        <div class="list">
            <div class="info-header">차량 상세 검색</div>

            <div class="filter-box-big">
                <div class="filter-box">
                    <label for="provinceSelect">시/도</label>
                    <select id="provinceSelect">
                        <option value="">시/도를 선택하세요</option>
                        <option th:each="province : ${provinceList}" th:value="${province}" th:text="${province}">
                        </option>
                    </select>

                    <label for="districtSelect">시/군/구</label>
                    <select id="districtSelect">
                        <option value="">시/군/구를 선택하세요</option>
                    </select>

                    <div class="btn-group">
                        <button type="button" id="searchBtn" class="btn-search">검색</button>
                    </div>

                </div>

                <div class="btn-group">
                    <button type="button" id="add_car" class="btn-update"
                        th:onclick="'location.href=\'' + @{/admin/vehicles/add} + '\''">
                        주차장에 새 차량을 등록
                    </button>
                </div>
            </div>

            <table class="table-box">
                <thead>
                    <tr>
                        <th style="width: 10%;">차량 번호</th>
                        <th style="width: 10%;">제조사</th>
                        <th style="width: 15%;">모델명</th>
                        <th style="width: 15%;">등급</th>
                        <th style="width: 15%;">카테고리</th>
                        <th style="width: 15%;">대여 상태</th>
                        <th style="width: 20%;">현재 위치한 주차장</th>
                    </tr>
                </thead>
                <tbody id="carList">
                    <tr th:each="car : ${cars}" th:attr="data-href=@{/admin/vehicles/{carId}(carId=${car.carId})}"
                        onclick="location.href=this.getAttribute('data-href')">
                        <td th:text="${car.carId}"></td>
                        <td th:text="${car.model.modelBrand}"></td>
                        <td th:text="${car.model.modelName}"></td>
                        <td th:text="${car.carGrade}"></td>
                        <td th:text="${car.carCategory}"></td>
                        <td th:text="${car.carStatus}"></td>
                        <td th:text="${car.parking.parkingName}"></td>
                    </tr>
                </tbody>
            </table>

        </div>
    </div>

</body>

</html>