<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf"
    layout:decorate="~{layout/layout}">

<head>
    <title>ì°¨ëŸ‰ ê´€ë¦¬ ìˆ˜ì •</title>

    <link rel="stylesheet" th:href="@{/css/car/car-update.css}">
    <script th:src="@{/js/car/carModify.js}" defer></script>

</head>

<body th:data-car-id="${modify.carId}">
    <div class="content" layout:fragment="content">

        <div class="header">
            ì°¨ëŸ‰ ê´€ë¦¬
        </div>

        <div class="info">
            <div class="header-sm">
                ì°¨ëŸ‰ ê´€ë¦¬ > ì°¨ëŸ‰ ìƒì„¸ ì¡°íšŒ > ì°¨ëŸ‰ ìˆ˜ì •
            </div>
            <form id="model_modify" th:action="@{/admin/vehicles/modify/{carId}(carId=${modify.carId})}" method="post">
                <div class="info-box-big">

                    <div class="info-box box1">
                        <div class="info-box-title" th:text="|${modify.carId}ë²ˆ ì°¨ëŸ‰ ì •ë³´ ë³€ê²½|"></div>
                        <div class="info-box-content">

                            <input type="hidden" name="_method" value="PUT">
                            <input type="hidden" id="carId" th:value="${modify.carId}">

                            <div class="info-box-content-row">
                                <label for="modelBrand">ì œì¡°ì‚¬</label>
                                <select id="modelBrand" name="model.modelBrand">
                                    <option th:each="brand: ${mBrandList}" th:value="${brand}" th:text="${brand}"
                                        th:selected="${modify.model.modelBrand == brand}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="modelName">ëª¨ë¸ëª…</label>
                                <select id="modelName" name="model.modelName">
                                    <option th:each="mName: ${mNameList}" th:value="${mName}" th:text="${mName}"
                                        th:selected="${modify.model.modelName == mName}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="carYear">ì—°ì‹</label>
                                <select id="carYear" name="carYear">
                                    <option th:each="year: ${yearList}" th:value="${year}" th:text="${year}"
                                        th:selected="${modify.carYear == year}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="carFuel">ì—°ë£Œ</label>
                                <select id="carFuel" name="carFuel">
                                    <option th:each="fuel : ${fuelList}" th:value="${fuel}" th:text="${fuel}"></option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="carGrade">ë“±ê¸‰</label>
                                <select id="carGrade" name="carGrade">
                                    <option th:each="grade : ${gradeList}" th:value="${grade}" th:text="${grade}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="carCategory">ì„œë¹„ìŠ¤ ì¹´í…Œê³ ë¦¬</label>
                                <select id="carCategory" name="carCategory" required>
                                    <option value="0">ë¹ ë¥¸ëŒ€ì—¬</option>
                                    <option value="1">ë‹¨ê¸°ëŒ€ì—¬</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="info-box box2">
                        <div class="info-box-title">ë³´ìœ  ì£¼ì°¨ì¥ ë³€ê²½</div>
                        <div class="info-box-content two">
                            <div class="info-box-content-row">
                                <label for="parkingProvince">ë„/ì‹œ</label>
                                <select id="parkingProvince" name="parking.province">
                                    <option value="">ë„/ì‹œ ì„ íƒ</option>
                                    <option th:each="province : ${provinceList}" th:value="${province}"
                                        th:text="${province}"
                                        th:selected="${province == modify.parking.parkingProvince}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="parkingDistrict">í–‰ì •êµ¬ì—­</label>
                                <select id="parkingDistrict" name="parking.district">
                                    <option value="">í–‰ì •êµ¬ì—­ ì„ íƒ</option>
                                    <option th:each="district : ${districtList}" th:value="${district}"
                                        th:text="${district}"
                                        th:selected="${district == modify.parking.parkingDistrict}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="carParking">ì£¼ì°¨ì¥ ì´ë¦„</label>
                                <select id="carParking" name="parking.parkingId">
                                    <option value="">ì£¼ì°¨ì¥ ì„ íƒ</option>
                                    <option th:each="parking : ${parkingList}" th:value="${parking.parkingId}"
                                        th:text="${parking.parkingName}"
                                        th:selected="${parking.parkingId == modify.parking.parkingId}">
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="info-box-content">
                            <div class="info-box-content-row">
                                <label for="parkingLatitude">ìœ„ë„</label>
                                <input type="text" id="parkingLatitude" name="parkingLatitude" readonly />
                            </div>
                            <div class="info-box-content-row">
                                <label for="parkingLongitude">ê²½ë„</label>
                                <input type="text" id="parkingLongitude" name="parkingLongitude" readonly />
                            </div>
                        </div>
                    </div>

                </div>

                <div class="btn-group">
                    <button type="button" class="btn-go-back"
                        th:onclick="'location.href=\'' + @{/admin/vehicles} + '\''">
                        ëª©ë¡ìœ¼ë¡œ
                    </button>
                    <div>
                        <button type="button" class="btn-reset" id="reset"
                            th:onclick="'location.href=\'' + @{/admin/vehicles/{carId}(carId=${modify.carId})} + '\''">
                            ì·¨ì†Œí•˜ê¸°
                        </button>
                        <button type="submit" class="btn-update" id="submit">
                            ìˆ˜ì •ì™„ë£Œ
                        </button>
                    </div>
                </div>
            </form>
        </div>

    </div>

    <th:block layout:fragment="js">
        <script>
            document.getElementById("model_modify").addEventListener("submit", function (event) {
                event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë°©ì§€

                const carId = document.getElementById("carId")?.value;
                const modelName = document.getElementById("modelName")?.value;
                const carCategory = document.getElementById("carCategory")?.value;
                const carStatus = document.getElementById("carStatus")?.value;
                const carYear = document.getElementById("carYear")?.value;
                const carFuel = document.getElementById("carFuel")?.value;
                const carGrade = document.getElementById("carGrade")?.value;
                const carOptions = document.getElementById("carOptions")?.value;
                const parkingId = document.getElementById("carParking")?.value;

                console.log("ğŸ”¹ ì „ì†¡ ë°ì´í„°:");
                console.log("carId:", carId);
                console.log("modelName:", modelName);
                console.log("carCategory:", carCategory);
                console.log("carStatus:", carStatus);
                console.log("carYear:", carYear);
                console.log("carFuel:", carFuel);
                console.log("carGrade:", carGrade);
                console.log("carOptions:", carOptions);
                console.log("parkingId:", parkingId);

                fetch(`/admin/vehicles/modify/${carId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: { modelName: modelName },
                        carCategory: carCategory,
                        carStatus: carStatus,
                        carYear: carYear,
                        carFuel: carFuel,
                        carGrade: carGrade,
                        carOptions: carOptions,
                        parking: { parkingId: parkingId }
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("ìˆ˜ì • ì™„ë£Œ");
                            window.location.href = `/admin/vehicles/${carId}`;
                        } else {
                            alert("ìˆ˜ì • ì‹¤íŒ¨: " + data.message);
                        }
                    })
                    .catch(error => console.error("Error:", error));
            });

        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const provinceSelect = document.getElementById("parkingProvince");
                const districtSelect = document.getElementById("parkingDistrict");
                const parkingSelect = document.getElementById("carParking");
                const latitudeInput = document.getElementById("parkingLatitude");
                const longitudeInput = document.getElementById("parkingLongitude");

                // âœ… í˜„ì¬ ì„ íƒëœ ê°’ ê°€ì ¸ì˜¤ê¸°
                const defaultProvince = provinceSelect.value;
                const defaultDistrict = districtSelect.value;
                const defaultParkingId = parkingSelect.value;

                // âœ… 1. ë„/ì‹œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                fetch("/admin/vehicles/provinces")
                    .then(response => response.json())
                    .then(provinces => {
                        provinceSelect.innerHTML = '<option value="">ë„/ì‹œ ì„ íƒ</option>';
                        provinces.forEach(province => {
                            let option = new Option(province, province);
                            if (province === defaultProvince) option.selected = true;
                            provinceSelect.add(option);
                        });

                        if (defaultProvince) {
                            provinceSelect.dispatchEvent(new Event("change"));
                        }
                    })
                    .catch(error => console.error("Error fetching provinces:", error));

                // âœ… 2. ë„/ì‹œ ì„ íƒ ì‹œ í–‰ì •êµ¬ì—­ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                provinceSelect.addEventListener("change", function () {
                    const province = this.value;
                    districtSelect.innerHTML = '<option value="">í–‰ì •êµ¬ì—­ ì„ íƒ</option>';
                    parkingSelect.innerHTML = '<option value="">ì£¼ì°¨ì¥ ì„ íƒ</option>';
                    latitudeInput.value = "";
                    longitudeInput.value = "";

                    if (province) {
                        fetch(`/admin/vehicles/districts?province=${encodeURIComponent(province)}`)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(district => {
                                    let option = new Option(district, district);
                                    if (district === defaultDistrict) option.selected = true;
                                    districtSelect.add(option);
                                });

                                if (defaultDistrict) {
                                    districtSelect.dispatchEvent(new Event("change"));
                                }
                            })
                            .catch(error => console.error("Error fetching districts:", error));
                    }
                });

                // âœ… 3. í–‰ì •êµ¬ì—­ ì„ íƒ ì‹œ ì£¼ì°¨ì¥ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                districtSelect.addEventListener("change", function () {
                    const province = provinceSelect.value;
                    const district = this.value;
                    parkingSelect.innerHTML = '<option value="">ì£¼ì°¨ì¥ ì„ íƒ</option>';
                    latitudeInput.value = "";
                    longitudeInput.value = "";

                    if (province && district) {
                        fetch(`/admin/vehicles/parkings?province=${encodeURIComponent(province)}&district=${encodeURIComponent(district)}`)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(parking => {
                                    let option = new Option(parking.parkingName, parking.parkingId);
                                    option.dataset.latitude = parseFloat(parking.parkingLatitude).toFixed(6); // âœ… ì†Œìˆ˜ì  6ìë¦¬ ìœ ì§€
                                    option.dataset.longitude = parseFloat(parking.parkingLongtitude).toFixed(6); // âœ… ì†Œìˆ˜ì  6ìë¦¬ ìœ ì§€
                                    parkingSelect.add(option);
                                });

                                setTimeout(() => {
                                    parkingSelect.value = defaultParkingId;
                                    parkingSelect.dispatchEvent(new Event("change"));
                                }, 100);
                            })
                            .catch(error => console.error("Error fetching parkings:", error));
                    }
                });

                // âœ… 4. ì£¼ì°¨ì¥ ì„ íƒ ì‹œ ìœ„ë„/ê²½ë„ ì…ë ¥
                parkingSelect.addEventListener("change", function () {
                    const selectedOption = parkingSelect.options[parkingSelect.selectedIndex];
                    latitudeInput.value = selectedOption.dataset.latitude || "";
                    longitudeInput.value = selectedOption.dataset.longitude || "";
                });
            });
        </script>

    </th:block>

</body>

</html>