<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf"
    layout:decorate="~{layout/layout}">

<head>
    <title>Ï∞®Îüâ Í¥ÄÎ¶¨ ÏàòÏ†ï</title>

    <link rel="stylesheet" th:href="@{/css/car/car-update.css}">
    <script th:src="@{/js/car/carModify.js}" defer></script>

</head>

<body th:data-car-id="${modify.carId}">
    <div class="content" layout:fragment="content">

        <div class="header">
            Ï∞®Îüâ Í¥ÄÎ¶¨
        </div>

        <div class="info">
            <div class="header-sm">
                Ï∞®Îüâ Í¥ÄÎ¶¨ > Ï∞®Îüâ ÏÉÅÏÑ∏ Ï°∞Ìöå > Ï∞®Îüâ ÏàòÏ†ï
            </div>
            <form id="model_modify" th:action="@{/admin/vehicles/modify/{carId}(carId=${modify.carId})}" method="post">
                <div class="info-box-big">

                    <div class="info-box box1">
                        <div class="info-box-title" th:text="|${modify.carId}Î≤à Ï∞®Îüâ Ï†ïÎ≥¥ Î≥ÄÍ≤Ω|"></div>
                        <div class="info-box-content">

                            <input type="hidden" name="_method" value="PUT">
                            <input type="hidden" id="carId" th:value="${modify.carId}">

                            <div class="info-box-content-row">
                                <label for="modelBrand">Ï†úÏ°∞ÏÇ¨</label>
                                <select id="modelBrand" name="model.modelBrand">
                                    <option th:each="brand: ${mBrandList}" th:value="${brand}" th:text="${brand}"
                                        th:selected="${modify.model.modelBrand == brand}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="modelName">Î™®Îç∏Î™Ö</label>
                                <select id="modelName" name="model.modelName">
                                    <option th:each="mName: ${mNameList}" th:value="${mName}" th:text="${mName}"
                                        th:selected="${modify.model.modelName == mName}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="carYear">Ïó∞Ïãù</label>
                                <select id="carYear" name="carYear">
                                    <option th:each="year: ${yearList}" th:value="${year}" th:text="${year}"
                                        th:selected="${modify.carYear == year}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="carFuel">Ïó∞Î£å</label>
                                <select id="carFuel" name="carFuel">
                                    <option th:each="fuel : ${fuelList}" th:value="${fuel}" th:text="${fuel}"></option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="carGrade">Îì±Í∏â</label>
                                <select id="carGrade" name="carGrade">
                                    <option th:each="grade : ${gradeList}" th:value="${grade}" th:text="${grade}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="carCategory">ÏÑúÎπÑÏä§ Ïπ¥ÌÖåÍ≥†Î¶¨</label>
                                <select id="carCategory" name="carCategory" required>
                                    <option value="0">Îπ†Î•∏ÎåÄÏó¨</option>
                                    <option value="1">Îã®Í∏∞ÎåÄÏó¨</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="info-box box2">
                        <div class="info-box-title">Î≥¥Ïú† Ï£ºÏ∞®Ïû• Î≥ÄÍ≤Ω</div>
                        <div class="info-box-content two">
                            <div class="info-box-content-row">
                                <label for="parkingProvince">ÎèÑ/Ïãú</label>
                                <select id="parkingProvince" name="parking.province">
                                    <option value="">ÎèÑ/Ïãú ÏÑ†ÌÉù</option>
                                    <option th:each="province : ${provinceList}" th:value="${province}"
                                        th:text="${province}"
                                        th:selected="${province == modify.parking.parkingProvince}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="parkingDistrict">ÌñâÏ†ïÍµ¨Ïó≠</label>
                                <select id="parkingDistrict" name="parking.district">
                                    <option value="">ÌñâÏ†ïÍµ¨Ïó≠ ÏÑ†ÌÉù</option>
                                    <option th:each="district : ${districtList}" th:value="${district}"
                                        th:text="${district}"
                                        th:selected="${district == modify.parking.parkingDistrict}">
                                    </option>
                                </select>
                            </div>
                            <div class="info-box-content-row">
                                <label for="carParking">Ï£ºÏ∞®Ïû• Ïù¥Î¶Ñ</label>
                                <select id="carParking" name="parking.parkingId">
                                    <option value="">Ï£ºÏ∞®Ïû• ÏÑ†ÌÉù</option>
                                    <option th:each="parking : ${parkingList}" th:value="${parking.parkingId}"
                                        th:text="${parking.parkingName}"
                                        th:selected="${parking.parkingId == modify.parking.parkingId}">
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="info-box-content">
                            <div class="info-box-content-row">
                                <label for="parkingLatitude">ÏúÑÎèÑ</label>
                                <input type="text" id="parkingLatitude" name="parkingLatitude" readonly />
                            </div>
                            <div class="info-box-content-row">
                                <label for="parkingLongitude">Í≤ΩÎèÑ</label>
                                <input type="text" id="parkingLongitude" name="parkingLongitude" readonly />
                            </div>
                        </div>
                    </div>

                </div>

                <div class="btn-group">
                    <button type="button" class="btn-go-back"
                        th:onclick="'location.href=\'' + @{/admin/vehicles} + '\''">
                        Î™©Î°ùÏúºÎ°ú
                    </button>
                    <div>
                        <button type="button" class="btn-reset" id="reset"
                            th:onclick="'location.href=\'' + @{/admin/vehicles/{carId}(carId=${modify.carId})} + '\''">
                            Ï∑®ÏÜåÌïòÍ∏∞
                        </button>
                        <button type="submit" class="btn-update" id="submit">
                            ÏàòÏ†ïÏôÑÎ£å
                        </button>
                    </div>
                </div>
            </form>
        </div>

    </div>

    <th:block layout:fragment="js">
        <script>
            document.getElementById("model_modify").addEventListener("submit", function (event) {
                event.preventDefault(); // Í∏∞Î≥∏ Ìèº Ï†úÏ∂ú Î∞©ÏßÄ

                const carId = document.getElementById("carId")?.value;
                const modelName = document.getElementById("modelName")?.value;
                const carCategory = document.getElementById("carCategory")?.value;
                const carStatus = document.getElementById("carStatus")?.value;
                const carYear = document.getElementById("carYear")?.value;
                const carFuel = document.getElementById("carFuel")?.value;
                const carGrade = document.getElementById("carGrade")?.value;
                const carOptions = document.getElementById("carOptions")?.value;
                const parkingId = document.getElementById("carParking")?.value;

                console.log("üîπ Ï†ÑÏÜ° Îç∞Ïù¥ÌÑ∞:");
                console.log("carId:", carId);
                console.log("modelName:", modelName);
                console.log("carCategory:", carCategory);
                console.log("carStatus:", carStatus);
                console.log("carYear:", carYear);
                console.log("carFuel:", carFuel);
                console.log("carGrade:", carGrade);
                console.log("carOptions:", carOptions);
                console.log("parkingId:", parkingId);

                fetch(`/admin/vehicles/modify/${carId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: { modelName: modelName },
                        carCategory: carCategory,
                        carStatus: carStatus,
                        carYear: carYear,
                        carFuel: carFuel,
                        carGrade: carGrade,
                        carOptions: carOptions,
                        parking: { parkingId: parkingId }
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert("ÏàòÏ†ï ÏôÑÎ£å");
                            window.location.href = `/admin/vehicles/${carId}`;
                        } else {
                            alert("ÏàòÏ†ï Ïã§Ìå®: " + data.message);
                        }
                    })
                    .catch(error => console.error("Error:", error));
            });

        </script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const provinceSelect = document.getElementById("parkingProvince");
                const districtSelect = document.getElementById("parkingDistrict");
                const parkingSelect = document.getElementById("carParking");
                const latitudeInput = document.getElementById("parkingLatitude");
                const longitudeInput = document.getElementById("parkingLongitude");

                // ‚úÖ ÌòÑÏû¨ ÏÑ†ÌÉùÎêú Í∞í Í∞ÄÏ†∏Ïò§Í∏∞
                const defaultProvince = provinceSelect.value;
                const defaultDistrict = districtSelect.value;
                const defaultParkingId = parkingSelect.value;

                // ‚úÖ 1. ÎèÑ/Ïãú Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
                fetch("/admin/vehicles/provinces")
                    .then(response => response.json())
                    .then(provinces => {
                        provinceSelect.innerHTML = '<option value="">ÎèÑ/Ïãú ÏÑ†ÌÉù</option>';
                        provinces.forEach(province => {
                            let option = new Option(province, province);
                            if (province === defaultProvince) option.selected = true;
                            provinceSelect.add(option);
                        });

                        if (defaultProvince) {
                            provinceSelect.dispatchEvent(new Event("change"));
                        }
                    })
                    .catch(error => console.error("Error fetching provinces:", error));

                // ‚úÖ 2. ÎèÑ/Ïãú ÏÑ†ÌÉù Ïãú ÌñâÏ†ïÍµ¨Ïó≠ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
                provinceSelect.addEventListener("change", function () {
                    const province = this.value;
                    districtSelect.innerHTML = '<option value="">ÌñâÏ†ïÍµ¨Ïó≠ ÏÑ†ÌÉù</option>';
                    parkingSelect.innerHTML = '<option value="">Ï£ºÏ∞®Ïû• ÏÑ†ÌÉù</option>';
                    latitudeInput.value = "";
                    longitudeInput.value = "";

                    if (province) {
                        fetch(`/admin/vehicles/districts?province=${encodeURIComponent(province)}`)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(district => {
                                    let option = new Option(district, district);
                                    if (district === defaultDistrict) option.selected = true;
                                    districtSelect.add(option);
                                });

                                if (defaultDistrict) {
                                    districtSelect.dispatchEvent(new Event("change"));
                                }
                            })
                            .catch(error => console.error("Error fetching districts:", error));
                    }
                });

                // ‚úÖ 3. ÌñâÏ†ïÍµ¨Ïó≠ ÏÑ†ÌÉù Ïãú Ï£ºÏ∞®Ïû• Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
                districtSelect.addEventListener("change", function () {
                    const province = provinceSelect.value;
                    const district = this.value;
                    parkingSelect.innerHTML = '<option value="">Ï£ºÏ∞®Ïû• ÏÑ†ÌÉù</option>';
                    latitudeInput.value = "";
                    longitudeInput.value = "";

                    if (province && district) {
                        fetch(`/admin/vehicles/parkings?province=${encodeURIComponent(province)}&district=${encodeURIComponent(district)}`)
                            .then(response => response.json())
                            .then(data => {
                                data.forEach(parking => {
                                    let option = new Option(parking.parkingName, parking.parkingId);
                                    option.dataset.latitude = parseFloat(parking.parkingLatitude).toFixed(6); // ‚úÖ ÏÜåÏàòÏ†ê 6ÏûêÎ¶¨ Ïú†ÏßÄ
                                    option.dataset.longitude = parseFloat(parking.parkingLongtitude).toFixed(6); // ‚úÖ ÏÜåÏàòÏ†ê 6ÏûêÎ¶¨ Ïú†ÏßÄ
                                    parkingSelect.add(option);
                                });

                                setTimeout(() => {
                                    parkingSelect.value = defaultParkingId;
                                    parkingSelect.dispatchEvent(new Event("change"));
                                }, 100);
                            })
                            .catch(error => console.error("Error fetching parkings:", error));
                    }
                });

                // ‚úÖ 4. Ï£ºÏ∞®Ïû• ÏÑ†ÌÉù Ïãú ÏúÑÎèÑ/Í≤ΩÎèÑ ÏûÖÎ†•
                parkingSelect.addEventListener("change", function () {
                    const selectedOption = parkingSelect.options[parkingSelect.selectedIndex];
                    latitudeInput.value = selectedOption.dataset.latitude || "";
                    longitudeInput.value = selectedOption.dataset.longitude || "";
                });
            });
        </script>

    </th:block>

</body>

</html>