<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.road_friends.rentalcar.mapper.UserAdminMapper">

    <!-- 전체 회원 수 조회 -->
    <select id="getUserCount" resultType="int">
        SELECT COUNT(*) FROM user
    </select>

    <!-- 활성 사용자 수 조회 (user_status = 0) -->
    <select id="getActiveUserCount" resultType="int">
        SELECT COUNT(*) FROM user WHERE user_status = 0
    </select>

    <!-- 탈퇴 사용자 수 조회 (user_status = 1) -->
    <select id="getInactiveUserCount" resultType="int">
        SELECT COUNT(*) FROM user WHERE user_status = 1
    </select>

    <!-- 남자 사용자 수 조회 (user_gender = 0) -->
    <select id="getMaleUserCount" resultType="int">
        SELECT COUNT(*) FROM user WHERE user_gender = 0
    </select>

    <!-- 여자 사용자 수 조회 (user_gender = 1) -->
    <select id="getFemaleUserCount" resultType="int">
        SELECT COUNT(*) FROM user WHERE user_gender = 1
    </select>

    <!-- 연령대별 사용자 수 조회 -->
    <select id="getAgeGroupCount" resultType="int">
        SELECT COUNT(*)
        FROM user
        WHERE YEAR(user_birth) BETWEEN #{startYear} AND #{endYear}
    </select>

    <!-- 모든 사용자 목록 조회 (관리자용) -->
    <select id="selectAllUsers" resultType="com.road_friends.rentalcar.dto.UserDto">
        SELECT user_num, user_id, user_name, user_email, user_phone, user_address,
        user_status, user_gender, user_birth
        FROM user
        WHERE enabled = 1
        ORDER BY user_num
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 이름으로 사용자 목록 검색 (관리자용) -->
    <select id="searchUsersByName" resultType="com.road_friends.rentalcar.dto.UserDto">
        SELECT user_num, user_id, user_name, user_email, user_phone, user_address,
        user_status, user_gender, user_birth
        FROM user
        WHERE user_name LIKE CONCAT('%', #{name}, '%') AND enabled = 1
        ORDER BY user_num
        LIMIT #{size} OFFSET #{offset}
    </select>

    <!-- 전체 사용자 수 조회 (관리자용) -->
    <select id="selectUserCount" resultType="int">
        SELECT COUNT(*)
        FROM user
        WHERE enabled = 1
    </select>

    <!-- 이름으로 검색된 사용자 수 조회 (관리자용) -->
    <select id="searchUserCountByName" resultType="int">
        SELECT COUNT(*)
        FROM user
        WHERE user_name LIKE CONCAT('%', #{name}, '%') AND enabled = 1
    </select>

    <!-- 특정 사용자 상세 조회 (관리자용) -->
    <select id="getUserDetail"  resultType="com.road_friends.rentalcar.dto.UserDto">
        SELECT user_num, user_id, user_name, user_email, user_phone, user_address,
               user_status, user_gender, user_birth
        FROM user
        WHERE user_num = #{userNum} AND enabled = 1
    </select>

    <!-- 특정 사용자 정보 수정 (관리자용) -->
    <update id="updateUser">
        UPDATE user
        SET user_name = #{userName},
            user_email = #{userEmail},
            user_phone = #{userPhone},
            user_address = #{userAddress},
            user_status = #{userStatus},
            user_birth = #{userBirth}
        WHERE user_num = #{userNum} AND enabled = 1
    </update>

    <!-- 특정 사용자의 대여 기록 조회 (관리자용) -->
    <select id="getUserRentalHistory" resultType="com.road_friends.rentalcar.dto.RentalHistoryDto">
        SELECT
        fr.reservation_id AS reservationId,
        c.car_category AS category,
        fr.rental_datetime,
        fr.return_datetime,
        m.model_name AS model,  -- model 테이블에서 차량 모델명 가져오기
        fr.payment AS totalPrice,
        fr.rental_state
        FROM fast_reservation fr
        JOIN car c ON fr.car_id = c.car_id
        JOIN model m ON c.model_id = m.model_id  -- 모델명 가져오기
        WHERE fr.user_num = #{userNum}

        UNION ALL

        SELECT
        sr.reservation_s_id AS reservationId,
        c.car_category AS category,
        sr.reservation_s_start_date AS rental_datetime,
        sr.reservation_s_end_date AS return_datetime,
        m.model_name AS model,  -- model 테이블에서 차량 모델명 가져오기
        sr.payment AS totalPrice,
        sr.rental_state
        FROM short_reservation sr
        JOIN car c ON sr.car_id = c.car_id
        JOIN model m ON c.model_id = m.model_id  -- 모델명 가져오기
        WHERE sr.user_num = #{userNum}

        ORDER BY rental_datetime DESC
    </select>

    <!-- 특정 사용자의 면허 정보 조회 (관리자용) -->
    <select id="getUserLicenseDetail" resultType="com.road_friends.rentalcar.dto.LicenseDto">
        SELECT
        license_id AS licenseId,
        license_num AS licenseNum,
        license_date AS licenseDate,
        license_end_date AS licenseEndDate,
        license_photo_path AS licensePhotoPath,
        user_num AS userNum
        FROM license
        WHERE user_num = #{userNum}
        LIMIT 1
    </select>




</mapper>
