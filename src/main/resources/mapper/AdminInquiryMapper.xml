<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper  namespace="com.road_friends.rentalcar.mapper.AdminInquiryMapper">

    <!-- 문의사항 목록 조회 -->
    <select id="getInquiries" resultType="com.road_friends.rentalcar.dto.AdminInquiryDto">
        SELECT *
        FROM inquiries
        ORDER BY inquiries_num DESC
        LIMIT #{size}
        OFFSET #{offset};
    </select>

    <!-- 검색된 문의사항 목록 조회 -->
    <select id="getInquiriesByContent" resultType="com.road_friends.rentalcar.dto.AdminInquiryDto">
        SELECT *
        FROM inquiries
        WHERE inquiries_q LIKE CONCAT('%', #{content}, '%')
        ORDER BY inquiries_num DESC
        LIMIT #{size}
        OFFSET #{offset};
    </select>

    <!-- 전체 문의사항 수 조회 -->
    <select id="getTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM inquiries
    </select>

    <!-- 검색된 문의사항 수 조회 -->
    <select id="getTotalCountByContent" resultType="int">
        SELECT COUNT(*)
        FROM inquiries
        WHERE inquiries_q LIKE CONCAT('%', #{content}, '%')
    </select>


    <!-- 관리자 질문 상세 조회 -->
    <select id="findInquiryById" resultType="com.road_friends.rentalcar.dto.AdminInquiryDto">
        SELECT inquiries_num, user_num, admin_num, inquiries_q, inquiries_a, inquiries_q_created_at, inquiries_a_created_at, inquiries_status
        FROM inquiries
        WHERE inquiries_num = #{inquiryId};
    </select>

    <!-- 관리자 질문 답변 작성 -->
    <select id="findInquiryReplyById" resultType="com.road_friends.rentalcar.dto.AdminInquiryDto">
        SELECT inquiries_num, user_num, admin_num, inquiries_q, inquiries_a, inquiries_q_created_at, inquiries_a_created_at, inquiries_status
        FROM inquiries
        WHERE inquiries_num = #{inquiryId};
    </select>

    <!-- 관리자 질문 답변 등록 -->
    <update id="updateInquiryReply" >
        UPDATE inquiries
        SET admin_num = #{adminNum},
        inquiries_a = #{inquiriesA},
        inquiries_a_created_at = CONVERT_TZ(NOW(), @@global.time_zone, 'Asia/Seoul')
        WHERE inquiries_num = #{inquiryId};
    </update>

    <!-- 관리자 질문 답변만 삭제 -->
    <update id="clearInquiryAnswer" parameterType="com.road_friends.rentalcar.dto.AdminInquiryDto">
        UPDATE inquiries
        SET admin_num = NULL, inquiries_a = NULL, inquiries_a_created_at = NULL
        WHERE inquiries_num = #{inquiryId};
    </update>

    <!-- 문의 비활성화 (inquiries_status = 0) -->
    <update id="updateInquiryStatus" parameterType="map">
        UPDATE inquiries
        SET inquiries_status = #{status}
        WHERE inquiries_num = #{inquiryId}
    </update>

    <!-- 총 게시글 개수 -->
    <select id="countTotalInquiries" resultType="long">
        SELECT COUNT(*) FROM inquiries;
    </select>

    <!-- 답변 완료 게시글 개수 (inquiriesA가 NULL이 아닌 경우) -->
    <select id="countAnsweredInquiries" resultType="long">
        SELECT COUNT(*) FROM inquiries WHERE inquiries_a IS NOT NULL;
    </select>

    <!-- 미답변 게시글 개수 (inquiriesA가 NULL인 경우) -->
    <select id="countUnansweredInquiries" resultType="long">
        SELECT COUNT(*) FROM inquiries WHERE inquiries_a IS NULL;
    </select>

</mapper>