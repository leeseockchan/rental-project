<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.road_friends.rentalcar.mapper.ShortReservationMapper">

    <!--    ì˜ˆì•½ ëª©ë¡ ì¡°íšŒ -->
    <select id="getAllReservations" resultType="com.road_friends.rentalcar.dto.ShortReservationDto">
        select reservation_s_id, car_id, rental_station_start, reservation_s_start_date, reservation_s_end_date
        FROM short_reservation
    </select>

    <!--    ì˜ˆì•½ ì •ë³´ ì¡°íšŒ -->
    <select id="getReservationById" resultType="com.road_friends.rentalcar.dto.ShortReservationDto">
        select reservation_s_id, car_id, rental_station_start, reservation_s_start_date, reservation_s_end_date
        FROM short_reservation WHERE reservation_s_id=#{reservationId};
    </select>

    <!-- ì°¨ëŸ‰ ëª©ë¡ ì¡°íšŒ -->
    <select id="getAllCars" resultType="com.road_friends.rentalcar.dto.CarDto">
        SELECT c.*
        FROM car c
        JOIN parking p ON c.rental_station = p.parking_id
        WHERE p.parking_district = 'ìˆ˜ì›ì‹œ' AND c.car_category = 1 ;
    </select>

    <!-- íŠ¹ì • ì°¨ëŸ‰ ì¡°íšŒ  -->
    <select id="getCarById" resultMap="CarDetailResultMap">
        SELECT
        c.car_id, c.model_id, c.car_year, c.car_fuel, c.car_grade, c.car_options, c.rental_station,
        m.model_id, m.model_brand, m.model_name, m.model_category,
        m.model_amount_hour, m.model_amount_day,
        m.model_seate_num, m.model_transmission,
        p.parking_id, p.parking_name, p.parking_address, p.parking_latitude, p.parking_longtitude
        FROM car c
        JOIN model m ON c.model_id = m.model_id
        JOIN parking p ON c.rental_station = p.parking_id
        WHERE c.car_id = #{carId} AND c.car_category = 1;
    </select>

    <resultMap id="CarDetailResultMap" type="com.road_friends.rentalcar.dto.CarDto">
        <id property="carId" column="car_id"/>
        <result property="modelId" column="model_id"/>
        <result property="carYear" column="car_year"/>
        <result property="carFuel" column="car_fuel"/>
        <result property="carGrade" column="car_grade"/>
        <result property="carOptions" column="car_options"/>
        <result property="rentalStation" column="rental_station"/>

        <!-- ëª¨ë¸ ì •ë³´ -->
        <association property="model" javaType="com.road_friends.rentalcar.dto.ModelDto">
            <id property="modelId" column="model_id"/>
            <result property="modelName" column="model_name"/>
            <result property="modelBrand" column="model_brand"/>
            <result property="modelCategory" column="model_category"/>
            <result property="modelSeateNum" column="model_seate_num"/>
            <result property="modelTransmission" column="model_transmission"/>
        </association>

        <!-- ì£¼ì°¨ì¥ ì •ë³´ -->
        <association property="parking" javaType="com.road_friends.rentalcar.dto.ParkingDto">
            <id property="parkingId" column="parking_id"/>
            <result property="parkingName" column="parking_name"/>
            <result property="parkingAddress" column="parking_address"/>
            <result property="parkingLatitude" column="parking_latitude"/>
            <result property="parkingLongtitude" column="parking_longtitude"/>
        </association>

    </resultMap>


    <!--     ì˜ˆì•½í•˜ê¸°     -->
    <insert id="reserve" parameterType="com.road_friends.rentalcar.dto.ShortReservationDto">
        INSERT INTO short_reservation (car_id, rental_station_start, reservation_s_start_date, reservation_s_end_date, user_num,reservation_s_id, payment)
        VALUES (#{carId},#{rentalStationStart},#{reservationSStartDate},#{reservationSEndDate},#{userNum},#{reservationSId},#{totalPrice});
    </insert>

    <!--    ì˜ˆì•½ì·¨ì†Œ    -->
    <delete id="deleteReservation">
        DELETE FROM short_reservation WHERE reservation_s_id=#{reservationId};
    </delete>

    <!--    ì˜ˆì•½ìˆ˜ì •    -->
    <update id="updateReservation" parameterType="com.road_friends.rentalcar.dto.ShortReservationDto">
        UPDATE short_reservation
        SET car_id=#{carId}, rental_station_start=#{rentalLocation}, reservation_s_start_date=#{rentalDatetime}, reservation_s_end_date= #{returnDatetime}
        WHERE reservation_s_id=#{reservationId};
    </update>


    <!-- ì˜ˆì•½ ê°€ëŠ¥ ì°¨ëŸ‰ ì¡°íšŒ -->
    <select id="getAvailableCars" resultMap="resultMap">
        SELECT m.model_id, m.model_name, m.model_brand, m.model_category, m.model_seate_num,
        m.model_transmission, m.model_amount_day, m.model_amount_hour,
        c.car_id, c.car_year, c.car_fuel, c.car_grade, c.car_options, c.rental_station
        FROM car c
        JOIN model m ON c.model_id = m.model_id  -- ì°¨ëŸ‰ ëª¨ë¸ ì •ë³´ ì¡°íšŒ
        JOIN parking p ON c.rental_station = p.parking_id  -- ì°¨ëŸ‰ì˜ ëŒ€ì—¬ ì§€ì (ì§€ì—­) ì¡°íšŒ
        WHERE p.parking_province = #{province}
        AND p.parking_district = #{district}  -- ì„ íƒí•œ ì§€ì—­ í•„í„°ë§
        AND c.car_category = 1  -- ğŸš€ ë©”ì¸ ì¿¼ë¦¬ì—ì„œë„ í•„í„°ë§
        AND NOT EXISTS (
        -- ì´ë¯¸ í•´ë‹¹ ì§€ì—­ê³¼ ì‹œê°„ì— ì˜ˆì•½ëœ ì°¨ëŸ‰ ëª©ë¡ ì œì™¸
        SELECT 1 FROM short_reservation sr
        WHERE sr.car_id = c.car_id
        AND (
        (#{rentalDatetime} BETWEEN sr.reservation_s_start_date AND sr.reservation_s_end_date)
        OR (#{returnDatetime} BETWEEN sr.reservation_s_start_date AND sr.reservation_s_end_date)
        OR (sr.reservation_s_start_date BETWEEN #{rentalDatetime} AND #{returnDatetime})
        )
        )
        <if test="modelCategory != null and modelCategory.trim() != ''">
            AND m.model_category = #{modelCategory}
        </if>
        <if test="modelName != null and modelName.trim() != ''">
            AND m.model_name = #{modelName}
        </if>

    </select>

    <resultMap id="resultMap" type="com.road_friends.rentalcar.dto.CarDto">
        <id property="carId" column="car_id"/>

        <result property="carCategory" column="car_category"/>
        <result property="carStatus" column="car_status"/>
        <result property="carYear" column="car_year"/>
        <result property="carFuel" column="car_fuel"/>
        <result property="carGrade" column="car_grade"/>
        <result property="carOptions" column="car_options"/>
        <result property="rentalStation" column="rental_station"/>

        <association property="model" javaType="com.road_friends.rentalcar.dto.ModelDto">
            <id property="modelId" column="model_id"/>
            <result property="modelName" column="model_name"/>
            <result property="modelBrand" column="model_brand"/>
            <result property="modelCategory" column="model_category"/>
            <result property="modelSeateNum" column="model_seate_num"/>
            <result property="modelTransmission" column="model_transmission"/>
            <result property="modelAmountHour" column="model_amount_hour"/>
            <result property="modelAmountDay" column="model_amount_day"/>
        </association>
    </resultMap>
    <!--            -->

    <!--    ì‹œê°„ë‹¹ ìš”ê¸ˆ ì¡°íšŒ  -->
    <select id="getAmountHour" >
        SELECT m.model_amount_hour
        FROM car c
        JOIN model m ON c.model_id = m.model_id  -- ì°¨ëŸ‰ ëª¨ë¸ ì •ë³´ ì¡°íšŒ
        WHERE car_id=#{carId};
    </select>

    <!--    í•˜ë£¨ë‹¹ ìš”ê¸ˆ ì¡°íšŒ  -->
    <select id="getAmountDay" >
        SELECT m.model_amount_day
        FROM car c
        JOIN model m ON c.model_id = m.model_id  -- ì°¨ëŸ‰ ëª¨ë¸ ì •ë³´ ì¡°íšŒ
        WHERE car_id=#{carId};
    </select>

    <!--     ëª¨ë¸ ì¡°íšŒ       -->
    <select id="getModelById" parameterType="int" resultMap="ModelResultMap">
        SELECT model_id, model_brand, model_name, model_category, model_seate_num,
        model_transmission, model_amount_day, model_amount_hour
        FROM model
        WHERE model_id = (SELECT model_id FROM car WHERE car_id = #{carId});
    </select>
    <resultMap id="ModelResultMap" type="com.road_friends.rentalcar.dto.ModelDto">
        <id property="modelId" column="model_id"/>
        <result property="modelName" column="model_name"/>
        <result property="modelBrand" column="model_brand"/>
        <result property="modelCategory" column="model_category"/>
        <result property="modelSeateNum" column="model_seate_num"/>
        <result property="modelTransmission" column="model_transmission"/>
        <result property="modelAmountHour" column="model_amount_hour"/>
        <result property="modelAmountDay" column="model_amount_day"/>
    </resultMap>

    <!-- reservation í…Œì´ë¸”ì— ë¹ˆ ë°ì´í„° ì‚½ì…   -->
    <insert id="insertReservation" parameterType="com.road_friends.rentalcar.dto.ReservationDto" useGeneratedKeys="true" keyProperty="reservationId">
        INSERT INTO reservation (fast_reservation_id, short_reservation_id)
        VALUES (NULL, NULL)
    </insert>

    <!-- reservation í…Œì´ë¸”ì—ì„œ ìµœê·¼ ìƒì„±ëœ id ë¶ˆëŸ¬ì˜¤ê¸°     -->
    <select id="getLastInsertId" resultType="int">
        SELECT LAST_INSERT_ID();
    </select>

    <update id="updateShortReservationId">
        UPDATE reservation
        SET short_reservation_id = #{reservationId}
        WHERE reservation_id = #{reservationId};
    </update>

    <update id="updateCarStatusTo0" parameterType="int">
        UPDATE car
        SET car_status = 0
        WHERE car_id = #{carId};
    </update>

</mapper>